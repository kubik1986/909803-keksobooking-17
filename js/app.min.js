"use strict";!function(){var t,i=27,o=1,r=2,a=5,s=19,d={room:["комната","комнаты","комнат"],"guest-genitive":["гостя","гостей","гостей"]};window.utils={shuffleArray:function(e){for(var t=e.length-1;0<t;t--){var i=Math.floor(Math.random()*(t+1)),n=e[i];e[i]=e[t],e[t]=n}return e},pluralize:function(e,t){var i="";if(!d.hasOwnProperty(t))return i;var n=e%100;return s<n&&(n%=10),i=n===o?d[t][0]:r<=n&&n<a?d[t][1]:d[t][2]},activateFormFields:function(e){e.forEach(function(e){e.disabled=!1})},deactivateFormFields:function(e){e.forEach(function(e){e.disabled=!0})},onEscPress:function(e,t){e.keyCode===i&&(e.preventDefault(),t())},debounce:function(e){t&&window.clearTimeout(t),t=window.setTimeout(e,500)}}}(),function(){var e=document.querySelector(".spinner");window.spinner={show:function(){e.classList.contains("spinner--hidden")&&(e.classList.remove("spinner--hidden"),document.body.style.overflow="hidden")},hide:function(){e.classList.contains("spinner--hidden")||(e.classList.add("spinner--hidden"),document.body.style.overflow="visible")}}}(),window.CustomValidation=function(){this.invalidities=[]},window.CustomValidation.prototype={checkValidity:function(e){var t=e.validity;if(t.badInput&&this.addInvalidity("Неверное значение"),t.patternMismatch&&this.addInvalidity("Значение не соответствует указанному шаблону"),t.rangeOverflow){var i=e.getAttribute("max");this.addInvalidity("Значение должно быть меньше или равно "+i)}if(t.rangeUnderflow){var n=e.getAttribute("min");this.addInvalidity("Значение должно быть больше или равно "+n)}if(t.stepMismatch){var o=e.getAttribute("step");this.addInvalidity("Значение должно быть кратным "+o)}if(t.tooLong){var r=e.getAttribute("maxlength");this.addInvalidity("Максимальное количество символов: "+r+". Длина текста сейчас: "+e.value.length)}if(t.tooShort){var a=e.getAttribute("minlength");this.addInvalidity("Минимальное количество символов: "+a+". Длина текста сейчас: "+e.value.length)}t.valueMissing&&this.addInvalidity("Это поле обязательно для заполнения"),t.typeMismatch&&this.addInvalidity("Значение не соответствует указанному типу"),t.customError&&this.addInvalidity(e.validationMessage)},addInvalidity:function(e){this.invalidities.push(e)},getInvalidities:function(){return this.invalidities.join(". \n")},getInvaliditiesForHTML:function(){return this.invalidities.join(". <br>")}},function(){function o(e){window.utils.onEscPress(e,d)}function r(e){e.target.classList.contains("error__button")||d()}function i(){d()}var a=document.querySelector("main"),s=document.querySelector("#error").content.querySelector(".error"),n=document.querySelector("#success").content.querySelector(".success"),d=function(){a.querySelectorAll(".error, .success").forEach(function(e){e.remove()}),document.removeEventListener("keydown",o)};window.alerts={showError:function(e,t){var i=s.cloneNode(!0),n=i.querySelector(".error__button");i.querySelector(".error__message").innerHTML=e,a.appendChild(i),i.focus(),n.addEventListener("click",function(){d(),t()}),i.addEventListener("click",r),document.addEventListener("keydown",o)},showSuccess:function(e){var t=n.cloneNode(!0);t.querySelector(".success__message").innerHTML=e,a.appendChild(t),t.focus(),t.addEventListener("click",i),document.addEventListener("keydown",o)}}}(),function(){function o(e,t){var i=new XMLHttpRequest;return i.responseType="json",i.addEventListener("load",function(){200===i.status?e(i.response):t("Произошла ошибка. Статус ответа: "+i.status+" "+i.statusText)}),i.addEventListener("error",function(){t("Произошла ошибка соединения. Попробуйте повторить позднее.")}),i.addEventListener("timeout",function(){t("Время ожидания ответа сервера истекло.<br>Попробуйте повторить позднее.")}),i}var r="https://js.dump.academy/keksobooking";window.backend={load:function(e,t){var i=o(e,t);i.timeout=5e3,i.open("GET","https://js.dump.academy/keksobooking/data"),i.send()},save:function(e,t,i){var n=o(t,i);n.timeout=3e4,n.open("POST",r),n.send(e)}}}(),function(){function n(e,t){window.filterForm.updateState(e,t),window.utils.debounce(window.map.updatePins)}var o={"housing-type":"type","housing-price":"price","housing-rooms":"rooms","housing-guests":"guests"},e=document.querySelector(".map__filters"),t=e.querySelectorAll("select"),i=e.querySelectorAll('input[name="features"]'),r=e.querySelectorAll("select, fieldset");window.filterForm={defaultSelectValue:"any",state:{},updateState:function(e,t){this.state[e]=t},activate:function(){window.utils.activateFormFields(r)},deactivate:function(){e.reset(),this.state={type:this.defaultSelectValue,price:this.defaultSelectValue,rooms:this.defaultSelectValue,guests:this.defaultSelectValue,features:[]},window.utils.deactivateFormFields(r)},init:function(){t.forEach(function(i){i.addEventListener("change",function(){var e=o[i.name],t=i.value;n(e,t)})}),i.forEach(function(t){t.addEventListener("change",function(){var e=window.filterForm.state.features.slice();t.checked?e.push(t.value):e.splice(e.indexOf(t.value),1),n("features",e)})})}}}(),function(){function a(e,t){switch(t){case"low":return e.price<i;case"middle":return e.price>=i&&e.price<=n;case"high":return e.price>n;default:return!0}}function s(t,e){return e.every(function(e){return t.features.includes(e)})}var i=1e4,n=5e4;window.data={ads:[],filteredAds:[],initAds:function(){this.ads=this.ads.filter(function(e){return e.hasOwnProperty("offer")});var e=window.utils.shuffleArray(this.ads.slice());this.filteredAds=e.slice(0,5)},filterAds:function(){var r=window.filterForm.state;this.filteredAds=this.ads.filter(function(e){var t,i,n=!0;for(var o in r)if(r.hasOwnProperty(o)&&!(n="price"===o?a(e.offer,r[o]):"features"===o?s(e.offer,r[o]):(t=e.offer[o],(i=r[o])===window.filterForm.defaultSelectValue||i===t.toString())))return!1;return n}).slice(0,5)}}}(),function(){var o=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={create:function(e,t){var i=o.cloneNode(!0),n=i.querySelector("img");return i.dataset.id=e,i.style.left=t.location.x+"px",i.style.top=t.location.y+"px",i.style.transform="translate(-50%, -100%)",n.src=t.author.avatar,n.alt=t.offer.title,i}}}(),function(){var o=45,r=40,a={bungalo:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},s="room",d="guest-genitive",l=document.querySelector("#card").content.querySelector(".map__card");window.card={create:function(t){var e=l.cloneNode(!0),i=e.querySelectorAll(".popup__feature");if(e.querySelector(".popup__avatar").src=t.author.avatar,e.querySelector(".popup__title").textContent=t.offer.title,e.querySelector(".popup__text--address").textContent=t.offer.address,e.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",e.querySelector(".popup__type").textContent=a[t.offer.type],e.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" "+window.utils.pluralize(t.offer.rooms,s)+" для "+t.offer.guests+" "+window.utils.pluralize(t.offer.guests,d),e.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout,t.offer.hasOwnProperty("features")&&0<t.offer.features.length?i.forEach(function(e){!function(e,t){var i=e.classList[1].slice(e.classList[1].indexOf("--")+2);-1===t.indexOf(i)&&(e.style.display="none")}(e,t.offer.features)}):e.querySelector(".popup__features").style.display="none",t.offer.hasOwnProperty("description")&&""!==t.offer.description.trim()?e.querySelector(".popup__description").textContent=t.offer.description:e.querySelector(".popup__description").style.display="none",t.offer.hasOwnProperty("photos")&&0<t.offer.photos.length){var n=document.createDocumentFragment();e.querySelector(".popup__photo").remove(),t.offer.photos.forEach(function(e){var t=document.createElement("img");t.src=e,t.width=o,t.height=r,t.alt="Фотография жилья",t.classList.add("popup__photo"),n.appendChild(t)}),e.querySelector(".popup__photos").appendChild(n)}else e.querySelector(".popup__photos").style.display="none";return e}}}(),function(){var e=170,t=700,i=document.querySelector(".map"),o=i.querySelector(".map__pins"),r=[],n=null,a=null,s={element:document.querySelector(".map__pin--main"),size:{WIDTH:65,HEIGHT:81}};s.startPosition={left:s.element.style.left,top:s.element.style.top},s.positionLimit={minLeft:0,maxLeft:o.offsetWidth-s.size.WIDTH,minTop:e-s.size.HEIGHT,maxTop:t-s.size.HEIGHT};function d(e){function t(e){e.preventDefault(),window.app.isPageActive||window.app.activatePage();var t=r.x-e.clientX,i=r.y-e.clientY;r={x:e.clientX,y:e.clientY};var n=s.element.offsetLeft-t,o=s.element.offsetTop-i;n<s.positionLimit.minLeft?(n=s.positionLimit.minLeft,r.x<f-pageXOffset&&(r.x=f-pageXOffset)):n>s.positionLimit.maxLeft&&(n=s.positionLimit.maxLeft,r.x>p-pageXOffset&&(r.x=p-pageXOffset)),o<s.positionLimit.minTop?(o=s.positionLimit.minTop,r.y<h-pageYOffset&&(r.y=h-pageYOffset)):o>s.positionLimit.maxTop&&(o=s.positionLimit.maxTop,r.y>m-pageYOffset&&(r.y=m-pageYOffset)),v(n+"px",o+"px"),window.adForm.setAddress(window.map.getMainPinCoordinates())}e.preventDefault();var r={x:e.clientX,y:e.clientY},i=function(e){e.preventDefault(),document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",i)}function l(e){var t=e.currentTarget;n!==t&&(a&&(g(),w()),t.classList.add("map__pin--active"),_(+(n=t).dataset.id))}function c(){window.map.closeCard()}function u(e){window.utils.onEscPress(e,window.map.closeCard)}var f=Math.round(o.getBoundingClientRect().left+s.size.WIDTH/2),p=Math.round(o.getBoundingClientRect().left+o.offsetWidth-s.size.WIDTH/2),h=Math.round(e-s.size.HEIGHT/2),m=Math.round(t-s.size.HEIGHT/2),v=function(e,t){s.element.style.left=e,s.element.style.top=t},w=function(){n.classList.remove("map__pin--active"),n=null},_=function(e){a=window.card.create(window.data.filteredAds[e]),i.appendChild(a),a.querySelector(".popup__close").addEventListener("click",c),document.addEventListener("keydown",u)},g=function(){a.remove(),a=null,document.removeEventListener("keydown",u)};window.map={initMainPinHandler:function(){s.element.addEventListener("mousedown",d)},activate:function(){i.classList.remove("map--faded")},deactivate:function(){i.classList.add("map--faded")},renderPins:function(e){var n=document.createDocumentFragment();e.forEach(function(e,t){var i=window.pin.create(t,e);n.appendChild(i),r.push(i),i.addEventListener("click",l)}),o.appendChild(n)},clearPins:function(){r.forEach(function(e){e.remove()}),r=[]},updatePins:function(){window.map.closeCard(),window.map.clearPins(),window.data.filterAds(),window.map.renderPins(window.data.filteredAds)},getMainPinCoordinates:function(e){return void 0===e&&(e=!1),{x:Math.round(s.element.offsetLeft+s.size.WIDTH/2),y:e?Math.round(s.element.offsetTop+s.size.WIDTH/2):s.element.offsetTop+s.size.HEIGHT}},resetMainPinPos:function(){v(s.startPosition.left,s.startPosition.top)},closeCard:function(){a&&(g(),w())}}}(),function(){var i="js-file-error",r=1024;window.ImageLoader=function(e){this._maxFilesAmount=e.maxFilesAmount,this._previewInsertPosition=e.previewInsertPosition,this._fileChooser=e.fileChooser,this._dropZone=e.dropZone,this._loaderContainer=e.loaderContainer,this._preview=e.preview,this._previewClass=this._preview.className,this._highlightClass=e.highlightClass,this._fileTypes=e.fileTypes,this._maxFileSize=e.maxFileSize,this._imgSize=e.imgSize,this._imgAlt=e.imgAlt,this._isActive=!1,this._files=[],this._errors=[],this._init.call(this)},window.ImageLoader.prototype={_highlight:function(){this._dropZone.classList.contains(this._highlightClass)||this._dropZone.classList.add(this._highlightClass)},_unhighlight:function(){this._dropZone.classList.contains(this._highlightClass)&&this._dropZone.classList.remove(this._highlightClass)},_alert:function(e){var t=document.createElement("p");t.classList.add(i),t.innerHTML=e,t.style.marginTop="10px",t.style.marginBottom="10px",t.style.fontSize="14px",t.style.color="red",this._loaderContainer.parentElement.appendChild(t)},_validate:function(e){var t=!1,i="Допустимые типы файлов - "+this._fileTypes.join(", "),n="Максимальный размер файла - "+this._maxFileSize+" КБ",o=e.name.toLowerCase();return this._fileTypes.some(function(e){return o.endsWith(e)})?e.size>this._maxFileSize*r?this._errors.includes(n)||this._errors.push(n):t=!0:this._errors.includes(i)||this._errors.push(i),t},_clearErrors:function(){var e=this._loaderContainer.parentElement.querySelector("."+i);this._errors=[],e&&e.remove()},_updatePreviews:function(n){var o=this,r=0,a=document.createDocumentFragment();0<n.length?n.forEach(function(e){var i=new FileReader;i.addEventListener("load",function(){var e=document.createElement("div"),t=document.createElement("img");t.src=i.result,t.alt=o._imgAlt,t.width=o._imgSize.width,t.height=o._imgSize.height,t.style.borderRadius="5px",t.style.objectFit="cover",e.classList.add(o._previewClass),e.appendChild(t),a.appendChild(e),++r===n.length&&(o._deletePreviews(),"start"===o._previewInsertPosition?o._loaderContainer.insertBefore(a,o._loaderContainer.firstChild):o._loaderContainer.appendChild(a))}),i.readAsDataURL(e)}):o._setDefaultPreview()},_deletePreviews:function(){this._loaderContainer.querySelectorAll("."+this._previewClass).forEach(function(e){e.remove()})},_setDefaultPreview:function(){this._deletePreviews(),"start"===this._previewInsertPosition?this._loaderContainer.insertBefore(this._preview,this._loaderContainer.firstChild):this._loaderContainer.appendChild(this._preview)},_addFiles:function(e){var t=this;t._files=[],t._clearErrors(),e.length>t._maxFilesAmount&&t._errors.unshift("Максимальное количество файлов - "+t._maxFilesAmount);for(var i=0;i<e.length&&t._files.length!==t._maxFilesAmount;i++)t._validate(e[i])&&t._files.push(e[i]);if(0<t._errors.length){0===t._files.length?t._errors.unshift("Внимание: файлы не будут загружены"):t._errors.unshift("Внимание: будут загружены не все выбранные файлы");var n=t._errors.join(".<br>");t._alert(n)}},_init:function(){var t=this;["dragenter","dragover","dragleave","drop"].forEach(function(e){t._dropZone.addEventListener(e,function(e){e.preventDefault(),e.stopPropagation()})}),["dragenter","dragover"].forEach(function(e){t._dropZone.addEventListener(e,function(){t._isActive&&t._highlight()})}),["dragleave","drop"].forEach(function(e){t._dropZone.addEventListener(e,function(){t._isActive&&t._unhighlight()})}),t._dropZone.addEventListener("drop",t._onDrop.bind(t)),t._fileChooser.addEventListener("change",t._onInputChange.bind(t))},_onDrop:function(e){if(this._isActive){var t=e.dataTransfer,i=Array.from(t.files);this._addFiles(i),this._updatePreviews(this._files)}},_onInputChange:function(){if(this._isActive){var e=Array.from(this._fileChooser.files);this._addFiles(e),this._updatePreviews(this._files)}},activate:function(){this._isActive=!0},deactivate:function(){this._isActive=!1},reset:function(){this._files=[],this._clearErrors(),this._setDefaultPreview(),this._isActive=!1},getFiles:function(){return this._files}}}(),function(){function e(e){e.preventDefault(),window.app.resetPage()}function t(e){var t=e.target;switch(t.id){case"title":P(),k(f);break;case"type":b(t.value),h.value&&k(h);break;case"price":k(h);break;case"timein":case"timeout":F(t.value);break;case"room_number":T(t.value),k(_);break;case"capacity":I(),k(_)}}function i(e){e.preventDefault(),C=!1,L.forEach(function(e){k(e)}),C||M()}function n(){window.spinner.hide(),window.alerts.showSuccess("Ваше объявление<br>успешно размещено!"),H(),window.app.resetPage()}function o(e){window.spinner.hide(),window.alerts.showError("Ваше объявление не размещено.<br>"+e,M),H()}function r(){l.classList.add("ad-form--disabled"),window.utils.deactivateFormFields(c),q.deactivate(),A.deactivate()}var a="js-error-message",s=30,d=100,l=document.querySelector(".ad-form"),c=l.querySelectorAll("fieldset"),u=l.querySelector("#address"),f=l.querySelector("#title"),p=l.querySelector("#type"),h=l.querySelector("#price"),m=l.querySelector("#timein"),v=l.querySelector("#timeout"),w=l.querySelector("#room_number"),_=l.querySelector("#capacity"),g=l.querySelector(".ad-form__reset"),y=l.querySelector(".ad-form__submit"),S=l.querySelectorAll('input:not([type="file"]), select, textarea'),L=[f,h,_],E=!1,C=!1,x={bungalo:0,flat:1e3,house:5e3,palace:1e4},q=new window.ImageLoader({maxFilesAmount:1,previewInsertPosition:"start",fileChooser:l.querySelector("#avatar"),dropZone:l.querySelector(".ad-form-header__drop-zone"),loaderContainer:l.querySelector(".ad-form-header__upload"),preview:l.querySelector(".ad-form-header__preview"),highlightClass:"ad-form-header__drop-zone--highlighted",fileTypes:["jpg","jpeg","png","gif"],maxFileSize:300,imgSize:{width:40,height:44},imgAlt:"Аватар пользователя"}),A=new window.ImageLoader({maxFilesAmount:16,previewInsertPosition:"end",fileChooser:l.querySelector("#images"),dropZone:l.querySelector(".ad-form__drop-zone"),loaderContainer:l.querySelector(".ad-form__photo-container"),preview:l.querySelector(".ad-form__photo"),highlightClass:"ad-form__drop-zone--highlighted",fileTypes:["jpg","jpeg","png"],maxFileSize:1024,imgSize:{width:70,height:70},imgAlt:"Фотография жилья"}),P=function(){f.value=f.value.trim();var e=f.value.length;e<s&&0<e?f.setCustomValidity("Минимальное количество символов: "+s+". Длина текста сейчас: "+e):d<e?f.setCustomValidity("Максимальное количество символов: "+d+". Длина текста сейчас: "+e):f.setCustomValidity("")},b=function(e){h.min=x[e],h.placeholder=x[e]},F=function(e){m.value=e,v.value=e},T=function(t){var e=_.options;+t<100?Array.prototype.forEach.call(e,function(e){e.disabled=+e.value>+t||0==+e.value}):Array.prototype.forEach.call(e,function(e){e.disabled=0<+e.value}),I()},I=function(){_.options[_.selectedIndex].disabled?_.setCustomValidity("Укажите подходящее количество мест"):_.setCustomValidity("")},k=function(e){if(function(e){return null!==e.nextElementSibling&&e.nextElementSibling.classList.contains(a)}(e)&&z(e),!e.validity.valid){C||(e.focus(),C=!0),e.style.outline="2px dashed red";var t=new window.CustomValidation;t.checkValidity(e);var i=t.getInvaliditiesForHTML();e.insertAdjacentHTML("afterend",'<p class="'+a+'" style="margin-top: 7px; margin-bottom: 15px; padding-right: 20px; color: red;">'+i+"</p>")}},z=function(e){var t=e.nextElementSibling;e.style.outline=null,t.remove()},H=function(){l.classList.remove("ad-form--disabled"),window.utils.activateFormFields(c),q.activate(),A.activate()},M=function(){r(),window.backend.save(function(){var t=new FormData;S.forEach(function(e){"checkbox"===e.type&&!e.checked||t.append(e.name,e.value)});var e=q.getFiles();0<e.length&&t.append("avatar",e[0],e[0].name);var i=A.getFiles();return 0<i.length&&i.forEach(function(e){t.append("images",e,e.name)}),t}(),n,o),window.spinner.show()};window.adForm={activate:function(){H(),b(p.value),F(m.value),T(w.value),l.addEventListener("change",t),y.addEventListener("click",i),g.addEventListener("click",e),E=!0},deactivate:function(){r(),E&&(l.reset(),q.reset(),A.reset(),C&&(l.querySelectorAll("."+a).forEach(function(e){var t=e.previousElementSibling;z(t)}),C=!1),l.removeEventListener("change",t),y.removeEventListener("click",i),g.removeEventListener("click",e)),E=!1},setAddress:function(e){u.value=e.x+", "+e.y}}}(),function(){function t(e){window.data.ads=e,window.data.initAds(),window.map.renderPins(window.data.filteredAds),window.filterForm.activate()}var i=function(e){window.alerts.showError("Не удалось загрузить похожие объявления.<br>"+e,function(){window.backend.load(t,i)})};window.app={isPageActive:!1,activatePage:function(){window.map.activate(),window.adForm.activate(),this.isPageActive=!0,window.backend.load(t,i)},resetPage:function(){this.isPageActive&&(window.map.closeCard(),window.map.clearPins(),window.map.resetMainPinPos(),window.scrollTo(0,0)),window.map.deactivate(),window.filterForm.deactivate(),window.adForm.deactivate(),window.adForm.setAddress(window.map.getMainPinCoordinates(!0)),this.isPageActive=!1}},window.map.initMainPinHandler(),window.app.resetPage(),window.filterForm.init()}();